<template>
    <div>
        <el-input ref="profile_id" v-model="this.user.profile_id" type="text"></el-input>
        <el-form-item v-for="item in this.structure" :key="item.key"        
        :label="trans(item.label)"
                :prop="item.name"
                :rules="[
                {message: trans(item.errorMsg)}
                ]">            
            <el-input v-if="item.item=='el-input' " v-model="user[item.name]" :name="item.name" type="text"></el-input>
            <el-select @focus="loadList(item.apiUrl)" v-if="item.item=='el-select' " v-model="form[item.name]" :name="item.name" >
            <el-option
                v-for="option in lists"
                :key="option.id"
                :label="option.description"
                :value="option.id">
            </el-option>
            </el-select>              
            <el-upload
            v-if="item.item=='el-upload'"
            class="avatar-uploader"
            :headers="headerInfo"
            ref="upload"
            action=""
            name="avatar"
            :limit=1
            :on-success="handleAvatarSuccess"
            :before-upload="onBeforeUpload"
            :auto-upload="false">               
            <el-button slot="trigger" size="small" type="primary">انتخاب تصویر</el-button> 
                <img v-if="user.avatar" :src="user.avatar" class="img-fluid img-circle" alt="User profile picture">               
            </el-upload>                            
        </el-form-item>
    </div>
</template>
<style>

</style>
<script>
import {errorMessage} from '../../utilities';
export default {
    props:['user'],
    data(){
        return{
            structure:{},
            test:this.user,
            form: 
            {
                id:'',             
                profile_id:'',
                data:'',           
            },
            headerInfo: {
                'Accept': 'application/json'
            },
            formData:'',            
            }
    },
    methods:{
      loadUser:function(){
          return this.user.profile_id;
      },
      /*
      |--------------------------------------------------------------------------
      | Load Profile Structure
      | Added By e.bagherzadegan        
      |--------------------------------------------------------------------------
      |
      | This method load Profile Structure for edit
      |
      */      
      loadProfileSructure:function(){
        axios.get("../api/profiles/"+this.loadUser()).then(({data})=>(this.structure =JSON.parse(data.data.structure))).catch((error)=>{
            let msgErr = errorMessage(error.response.data.errors);
            this.$message({                                    
              message:msgErr,
              center: true,
              type: 'error'
            }); 
        });
      },
      /*
      |--------------------------------------------------------------------------
      | handleAvatarSuccess
      |--------------------------------------------------------------------------
      |
      | This method handleAvatarSuccess
      |
      */        
      handleAvatarSuccess(res, file) {
        this.user.avatar = URL.createObjectURL(file.raw);
      },
      /*
      |--------------------------------------------------------------------------
      | Validate Avatar Befor Upload
      |--------------------------------------------------------------------------
      |
      | This method Validate Avatar Befor Upload
      |
      */     
      onBeforeUpload(file) {
          const isJPG = file.type === 'image/jpeg';
          const isLt2M = file.size / 1024 / 1024 < 2;
          if (!isJPG) {
              this.$message.error('Avatar picture must be JPG format!');
          }
          if (!isLt2M) {
              this.$message.error('Avatar picture size can not exceed 2MB!');
          }
          return (isJPG & isLt2M);
      },       
    },
    created() {
        this.loadUser();
        this.loadProfileSructure();
    },
}
</script>
